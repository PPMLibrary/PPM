#-------------------------------------------------------------------------
#
#   ppm part_test Makefile
#
#   Generated by PPM CG
#
#-------------------------------------------------------------------------
PROGRAM  = part_test

PPMDIR    = /home/kevin/ppm-library/ppm
PPMNUMDIR = /home/kevin/ppm-library/ppmnumerics
CHECKPOINT= /home/kevin/ppm-library/checkpoint/src
HDF5 = /home/kevin/hdf5-1.8.11/hdf5

# Flags and settings, when you compile
FC      = mpif90
LDFLAGS = -L/home/kevin/ppm-library/metis/lib -latlas -lblas -lmetis  -L$(PPMDIR)/lib -L$(PPMNUMDIR)/lib -lppmnumerics -lppm -lmetis -llapack -lblas -L$(HDF5)/lib -lhdf5_fortran -lhdf5hl_fortran -I$(CHECKPOINT) -L$(CHECKPOINT) -lcheck
OPT     = -O3 -ffree-form -ffree-line-length-none -ffree-line-length-none -O0 -g -fbounds-check -fbacktrace -ftrapv -fno-automatic -ffree-line-length-none -Wall -ffpe-trap=zero,overflow,underflow -I/home/kevin/ppm-library/checkpoint -I$(HDF5)/include -lhdf5_fortran
INCL    = -I$(PPMDIR)/include/ppm -I$(PPMNUMDIR)/include/ppm -I$(HDF5)/include -I/home/kevin/ppm-library/checkpoint/src

### Usually you should not change these variables below.

# Collecting compilerflags in one variable.
FFLAGS= $(OPT) $(INCL)

###### You shouldn't need to change anything below this line #############
PPM  := ppm
SED  := /bin/sed
DEPS := $(PPMDIR)/utils/deps.sh
LOG  := compile.log
RUN  := $(PPMDIR)/utils/runcmd.sh

# Directory for object files
BUILDDIR   = obj
# Directory where to move the program when running 'make install'
DESTDIR    = ../bin

# generic variables

SOURCES := $(notdir $(wildcard *.f))
OBJECTS := $(SOURCES:%.f=$(BUILDDIR)/%.o)
DEPENDENCIES := $(SOURCES:%.f=$(BUILDDIR)/%.d)


####### Build and Install Targets ########################################
all: $(PROGRAM)

# Dont delete the given intermediate files
.SECONDARY: #$(DEPENDENCIES)

CPCMD = cp $< $@
$(BUILDDIR)/%.f : %.f
	@printf "  CP   %-42s" $<; \
        $(RUN) "$(CPCMD)" $(LOG) "Copying Error"

ENV = CPP="cpp" SED="$(SED)" INC="$(INCL)" OBJDIR="$(BUILDDIR)"
DEPCMD = $(DEPS) $< $@
$(BUILDDIR)/%.d : %.f $(BUILDDIR)/%.f
	@printf "  DEP  %-42s" $<; \
	$(ENV) $(RUN) "$(DEPCMD)" $(LOG) "Dependency Error"

COMPILECMD = $(FC) $(INCL) $(FFLAGS) -c -o $@ $<
$(BUILDDIR)/%.o : $(BUILDDIR)/%.f
	@printf "  FC   %-42s" $<; \
	$(RUN) "$(COMPILECMD)" $(LOG) "Compile Error"

LINKCMD = $(FC) $(OBJECTS) -o $@ $(LDFLAGS)
$(PROGRAM): $(OBJECTS)
	@printf " LINK  %-42s" $@; \
	$(RUN) "$(LINKCMD)" $(LOG) "Linking Error" \
	&& mv $(PROGRAM) $(DESTDIR)

###### Cleaning up #######################################################
clean:
	rm $(BUILDDIR)/*.o $(BUILDDIR)/*.mod

cleanall: clean
	rm $(FORTRANDIR)/*.f90 $(PROGRAM)

sinclude $(DEPENDENCIES)
